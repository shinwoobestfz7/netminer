<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>넷마이너 설문조사</title>
  <style>
    :root{--primary:#2563eb;--muted:#6b7280;--ring:#dbeafe;--green:#10b981;--red:#ef4444}
    *{box-sizing:border-box}
    body{font-family:'Noto Sans KR',system-ui,sans-serif;background:#f3f4f6;margin:0;padding:20px}
    .container{max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    h1{margin:0 0 6px;color:#111827}
    h2{margin:14px 0 6px;color:#111827}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    label{font-weight:700;font-size:14px;margin:14px 0 6px;display:block}
    select,input{width:100%;padding:12px;border-radius:10px;border:1px solid #e5e7eb;font-size:16px}
    select:focus,input:focus{outline:3px solid var(--ring);border-color:#93c5fd}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px}
    .btn{border:0;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer}
    .primary{background:var(--primary);color:#fff}
    .ghost{background:#f3f4f6}
    .success{background:var(--green);color:#fff}
    .danger{background:#fee2e2;color:#991b1b}
    table{width:100%;border-collapse:collapse;margin-top:18px;border-radius:10px;overflow:hidden}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:center;font-size:13px}
    .card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .hidden{display:none!important}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:50}
    .modal.hidden{display:none!important}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .modal-dialog{position:relative;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);width:min(92vw,480px);padding:20px}
    .modal-title{font-weight:800;font-size:20px;margin:0 0 6px}
    .modal-desc{color:#4b5563;margin-bottom:14px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin-left:8px}
    .small{font-size:12px;color:#6b7280}
    /* 로딩 모달 */
    .loading-content{display:flex;align-items:center;gap:12px}
    .spinner{width:32px;height:32px;border:4px solid #e5e7eb;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <h1>2025년도 교우관계 설문조사</h1>
    <div class="muted">Made by 10112</div>

    <div id="landing">
      <div class="btns" style="margin-top:10px">
        <button class="btn primary" id="goStudent">학생입니다</button>
        <button class="btn ghost" id="goTeacher">교사입니다</button>
      </div>
    </div>

    <div id="studentPage" class="hidden">
      <h2>학생 설문</h2>
      <div class="muted">같은 문항 내에서는 <b>중복 불가</b>이며, 본인 번호는 자동 제외됩니다.</div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>1. 번호</label>
          <select id="fromId"></select>
        </div>
        <div>
          <label>2. 성별</label>
          <select id="gender">
            <option value="">선택</option>
            <option>남</option>
            <option>여</option>
          </select>
        </div>
      </div>

      <div id="questions" style="margin-top:10px"></div>

      <div class="btns">
        <button class="btn primary" id="submitStudent">응답 제출</button>
        <button class="btn ghost" id="resetStudent">양식 초기화</button>
      </div>

      <h2 style="margin-top:24px">의사소통 빈도 설문조사</h2>
      <div class="muted">각 친구와의 의사소통 빈도를 선택하세요.</div>

      <!-- 1) 일반 의사소통 빈도 -->
      <div id="commSchool" class="card hidden" style="margin-top:8px">
        <h3>1) 의사소통 빈도 설문</h3>
        <div class="muted">각 친구에 대해 의사소통 빈도를 선택하세요.</div>
        <div id="commSchoolForm" style="margin-top:8px"></div>
        <div class="btns">
          <button class="btn primary" id="saveCommSchool">응답 제출</button>
          <button class="btn ghost" id="clearCommSchool">모두 비우기</button>
        </div>
      </div>

      <!-- 1-A. 일반 의사소통 "계기" -->
      <div id="reasonCommCard" class="card hidden" style="margin-top:12px">
        <h3>1-A) 친구들과 의사소통을 많이 하게 된 중요한 계기는 무엇인가요? <span class="pill">한 가지 선택</span></h3>
        <div class="muted">해당하는 항목 하나만 선택해 주세요.</div>
        <div id="reasonCommForm" style="margin-top:8px"></div>
        <div class="btns">
          <button class="btn primary" id="saveReasonComm">응답 제출</button>
          <button class="btn ghost" id="clearReasonComm">비우기</button>
        </div>
      </div>

      <!-- 2) 학업 의사소통 빈도 -->
      <div id="commAcad" class="card hidden" style="margin-top:12px">
        <h3>2) 학업 의사소통 빈도 설문</h3>
        <div class="muted">각 친구에 학업 소통 빈도를 선택하세요.</div>
        <div id="commAcadForm" style="margin-top:8px"></div>
        <div class="btns">
          <button class="btn primary" id="saveCommAcad">응답 제출</button>
          <button class="btn ghost" id="clearCommAcad">모두 비우기</button>
        </div>
      </div>

      <!-- 2-A. 학업 의사소통 "계기" -->
      <div id="reasonAcadCard" class="card hidden" style="margin-top:12px">
        <h3>2-A) 학업 의사소통을 많이 하게 된 중요한 계기는 무엇인가요? <span class="pill">한 가지 선택</span></h3>
        <div class="muted">해당하는 항목 하나만 선택해 주세요.</div>
        <div id="reasonAcadForm" style="margin-top:8px"></div>
        <div class="btns">
          <button class="btn primary" id="saveReasonAcad">응답 제출</button>
          <button class="btn ghost" id="clearReasonAcad">비우기</button>
        </div>
      </div>

      <!-- 3) 진학/진로 의사소통 빈도 -->
      <div id="commCareer" class="card hidden" style="margin-top:12px">
        <h3>3) 진학 또는 진로 의사소통 빈도 설문</h3>
        <div class="muted">진학/진로 주제로 친구들과 소통하는 빈도를 선택하세요.</div>
        <div id="commCareerForm" style="margin-top:8px"></div>
        <div class="btns">
          <button class="btn primary" id="saveCommCareer">응답 제출</button>
          <button class="btn ghost" id="clearCommCareer">모두 비우기</button>
        </div>
      </div>

      <!-- 3-A. 진학/진로 의사소통 "계기" -->
      <div id="reasonCareerCard" class="card hidden" style="margin-top:12px">
        <h3>3-A) 친구들과 진학 또는 진로 의사소통을 많이 하게 된 중요한 계기는 무엇인가요? <span class="pill">한 가지 선택</span></h3>
        <div class="muted">해당하는 항목 하나만 선택해 주세요.</div>
        <div id="reasonCareerForm" style="margin-top:8px"></div>
        <div class="btns">
          <button class="btn primary" id="saveReasonCareer">응답 제출</button>
          <button class="btn ghost" id="clearReasonCareer">비우기</button>
        </div>
      </div>
    </div>

    <div id="teacherPage" class="hidden">
      <h2>교사 대시보드</h2>
      <div class="muted">학생 설문 : Edge List / 학업,일반,진학 의사소통 빈도 : Matrix / 1-A ~ 3-A : Tabular</div>

      <div id="teacherLogin" class="card">
        <label>비밀번호</label>
        <input type="password" id="teacherPw" placeholder="비밀번호를 입력해주세요" />
        <div class="btns"><button class="btn primary" id="loginBtn">입장</button></div>
        <div id="loginMsg" class="muted"></div>
      </div>

      <div id="teacherBody" class="hidden">
        <div class="card">
          <div class="btns">
            <button class="btn success" id="downloadCsvBtn">학생 설문 CSV</button>
            <button class="btn ghost" id="downloadSchoolMatrix">일반 의사소통 빈도 CSV</button>
            <button class="btn ghost" id="downloadAcadMatrix">학업 의사소통 빈도 CSV</button>

            <!-- 추가 CSV -->
            <button class="btn ghost" id="downloadReasonComm">[1-A] 일반 의사소통 계기 CSV</button>
            <button class="btn ghost" id="downloadReasonAcad">[2-A] 학업 의사소통 계기 CSV</button>
            <button class="btn ghost" id="downloadCareerMatrix">[3] 진학,진로 의사소통 빈도 CSV</button>
            <button class="btn ghost" id="downloadReasonCareer">[3-A] 진학,진로 계기 CSV</button>

            <button class="btn danger" id="clearAllBtn">모든 응답 초기화</button>
          </div>
        </div>

        <!-- 미제출 현황 -->
        <div class="card" id="missingCard" style="margin-top:12px">
          <div class="btns">
            <button class="btn primary" id="refreshMissing">미제출 현황 새로고침</button>
          </div>
          <div class="small">넷마이너용 데이터는 기존 시트에만 저장</div>
          <div id="missingWrap" class="muted" style="margin-top:8px"></div>
        </div>

        <div class="muted"></div>
      </div>
    </div>
  </div>

  <div id="submitModal" class="modal hidden" style="display:none" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
      <h3 id="modalTitle" class="modal-title">제출이 완료되었습니다</h3>
      <div class="modal-desc">추가로 제출할 내용이 없다면 이 창을 닫아주세요.</div>
      <div class="modal-actions">
        <button id="modalClose" class="btn ghost">닫기</button>
      </div>
    </div>
  </div>

  <!-- 로딩 모달 -->
  <div id="loadingModal" class="modal hidden" style="display:none" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
      <div class="loading-content">
        <div class="spinner" aria-label="Loading"></div>
        <div>
          <div class="modal-title" style="margin:0">처리 중...</div>
          <div class="modal-desc" style="margin:4px 0 0">잠시만 기다려주세요.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================== 설정 ==================
    const API_BASE = 'https://script.google.com/macros/s/AKfycby91FaiVhzHJskrxRjHPRIal8sU7COiL3svnC9KCV1CgdaqKXcGstf9rFSIDdF--ZhznQ/exec';
    const CLASS_CODE = '6-3-2025';

    // ================== 데이터/상수 ==================
    const nameMap = {"01":"김규빈","02":"김도담","03":"김민재","04":"김유빈","05":"김태은","06":"김현서","07":"남규빈","08":"민경서","09":"박서현","10":"박수아","11":"백승민","12":"성신우","13":"심선우","14":"어경원","15":"오성훈","16":"이가은","17":"이수민","18":"이재우","19":"장시우","20":"정요한","21":"정유진","22":"정재연","23":"조우리","24":"조휘연","25":"채민서","26":"최한비","27":"한채호","28":"육서연"};
    const N = 28;
    const RELS = ['나와 가장 친한 친구는 누구인가요?','짝꿍이 되고 싶은 친구는 누구인가요?','학습 활동의 효율을 높이기 위해 함께하고 싶은 모둠원은 누구인가요?','과목에 상관 없이 공부를 하다 모르는 게 생겼을 때 누구에게 물어보고 싶나요?','성적ㆍ진로ㆍ교우관계 등 고민이 생겼을 때 대화를 나누고 싶은 친구는 누구인가요?','우리반에서 가장 중요하고 영향력 있는 의견을 내는 친구는 누구라고 생각하나요?','우리반에서 친구들에게 두루두루 호감을 얻고 있는 친구는 누구라고 생각하나요?'];

    const COMM_SCALE = [
      {v:1,t:'일주일에 한 번 이하'},
      {v:2,t:'일주일에 두세 번'},
      {v:3,t:'일주일에 여러 번'},
      {v:4,t:'하루에 한 번'},
      {v:5,t:'하루에 두세 번'},
      {v:6,t:'쉬는 시간마다'},
      {v:7,t:'학교 밖에서도 지속적으로'}
    ];

    const REASON_COMM = ['출신 중학교가 같음','관심사가 비슷함','취미가 비슷함','성격 또는 성향이 비슷함','기타'];
    const REASON_ACAD = ['같은 학원을 다님','성격이 비슷함','선호하는 공부 스타일이 비슷함','공부에서 배울 점이 있음','기타'];
    const REASON_CAREER = ['같은 대학 또는 같은 전공 진학을 희망함','진로 또는 직업 관심사가 비슷함','같은 진학 진로 프로그램에 참여했던 경험이 있음','진학 또는 진로에 대한 친구의 생각에서 배울 점이 있음','기타'];

    // ================== 유틸 ==================
    const pad2 = n => String(n).padStart(2,'0');
    const sid = n => `S${pad2(n)}`;
    function showModal(){ const m=document.getElementById('submitModal'); m.classList.remove('hidden'); m.style.display='flex'; }
    function hideModal(){ const m=document.getElementById('submitModal'); m.classList.add('hidden'); m.style.display='none'; }

    // 로딩 모달
    function showLoading(){ const m=document.getElementById('loadingModal'); if(!m) return; m.classList.remove('hidden'); m.style.display='flex'; }
    function hideLoading(){ const m=document.getElementById('loadingModal'); if(!m) return; m.classList.add('hidden'); m.style.display='none'; }

    window.addEventListener('load',()=>{ hideModal(); hideLoading(); });
    document.getElementById('modalClose').addEventListener('click', hideModal);

    async function apiGet(params){
      const url = API_BASE + '?' + new URLSearchParams(params).toString();
      const res = await fetch(url, { method:'GET' });
      const text = await res.text();
      try { return JSON.parse(text); } catch(e){ return { ok:false, error:'PARSE_ERROR', raw:text }; }
    }
    async function apiPost(payload){
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: {'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      try { return JSON.parse(text); } catch(e){ return { ok:false, error:'PARSE_ERROR', raw:text }; }
    }
    // 제출 로그
    async function pingSubmit(form){
      try{ await apiPost({ action:'pingSubmit', class_code: CLASS_CODE, form, from: sid(document.getElementById('fromId').value||'') }); }catch(e){}
    }

    // ================== 라우팅 ==================
    document.getElementById('goStudent').onclick=()=>{
      document.getElementById('landing').classList.add('hidden');
      document.getElementById('studentPage').classList.remove('hidden');
      initStudent();
    };
    document.getElementById('goTeacher').onclick=()=>{
      document.getElementById('landing').classList.add('hidden');
      document.getElementById('teacherPage').classList.remove('hidden');
      initTeacher();
    };

    // ================== 학생 화면 ==================
    function initStudent(){
      const idSel = document.getElementById('fromId');

      // 번호 셀렉트 초기화
      if(!idSel.options.length){
        const ph = document.createElement('option');
        ph.value = ''; ph.textContent = '번호를 선택하세요'; ph.selected = true; ph.disabled = true;
        idSel.appendChild(ph);
        for(let i=1;i<=N;i++){
          const v = pad2(i);
          const o = document.createElement('option');
          o.value = v; o.textContent = `${v} ${nameMap[v]||''}`;
          idSel.appendChild(o);
        }
      }

      // 관계 설문 렌더
      const qWrap = document.getElementById('questions');
      if(!qWrap.childElementCount){
        RELS.forEach((label,idx)=>{
          const wrap = document.createElement('div');
          const lab = document.createElement('label');
          lab.textContent = (idx+3)+'. '+label.replaceAll('_',' ')+' (최대 3명)';
          wrap.appendChild(lab);
          const row = document.createElement('div');
          row.className = 'row';
          for(let k=0;k<3;k++){
            const sel = document.createElement('select');
            sel.innerHTML = '<option value="">선택 안 함</option>';
            row.appendChild(sel);
          }
          wrap.appendChild(row);
          qWrap.appendChild(wrap);
        });
      }

      // 중복 방지
      function attachNoDuplicateHandlers(){
        document.querySelectorAll('#questions > div').forEach(block=>{
          if(block.dataset.bound==='1') return;
          block.dataset.bound='1';
          const selects = [...block.querySelectorAll('select')];
          const refreshDisabled = ()=>{
            const chosen = new Set(selects.map(s=>s.value).filter(Boolean));
            selects.forEach(sel=>{
              [...sel.options].forEach(opt=>{
                if(!opt.value) return;
                opt.disabled = (chosen.has(opt.value) && sel.value!==opt.value);
              });
            });
          };
          selects.forEach(sel=>{
            sel.addEventListener('change',()=>{
              const vals = selects.map(s=>s.value).filter(Boolean);
              const hasDup = vals.some((v,i)=> vals.indexOf(v)!==i);
              if(hasDup){ sel.value=''; alert('같은 번호는 한 문제에서 한 번만 선택할 수 있어요.'); }
              refreshDisabled();
            });
          });
          refreshDisabled();
        });
      }

      function fillOptions(){
        const me = document.getElementById('fromId').value;
        document.querySelectorAll('#questions select').forEach(sel=>{
          const cur = sel.value;
          sel.innerHTML = '<option value="">선택 안 함</option>';
          for(let i=1;i<=N;i++){
            const v = pad2(i);
            if(v===me) continue;
            const op = document.createElement('option');
            op.value = v; op.textContent = `${v} ${nameMap[v]||''}`;
            sel.appendChild(op);
          }
          if(cur) sel.value = cur;
        });
        attachNoDuplicateHandlers();
      }

      document.getElementById('fromId').addEventListener('change',()=>{
        fillOptions(); renderCommForms(); renderOnehotsVisibility();
      });
      fillOptions();

      document.getElementById('resetStudent').onclick=()=>{
        document.getElementById('gender').value='';
        document.getElementById('fromId').value='';
        document.querySelectorAll('#questions select').forEach(s=>s.value='');
        fillOptions(); renderCommForms(); renderOnehotsVisibility();
      };

      // 관계 설문 제출 (성별은 수집하지 않음)
      document.getElementById('submitStudent').onclick=async ()=>{
        const from = document.getElementById('fromId').value;
        const gender = ''; // 성별 CSV/저장값 제외
        if(!from){ alert('번호를 선택하세요.'); return; }

        const rows = [];
        document.querySelectorAll('#questions > div').forEach((block,idx)=>{
          const rel = RELS[idx];
          const selects = [...block.querySelectorAll('select')];
          const picked = [...new Set(selects.map(s=>s.value).filter(Boolean))];
          picked.forEach(v => rows.push({ from: sid(from), to: sid(v), relation_type: rel, gender }));
        });

        try{
          showLoading();
          const r = await apiPost({ action:'appendEdges', class_code: CLASS_CODE, rows });
          await pingSubmit('edges');
          if(!r.ok) throw new Error('save failed');
          alert('학생 설문이 제출되었습니다.'); showModal();
        }catch(e){
          alert('서버 오류가 발생했습니다. 다시 시도해 주세요.');
        } finally {
          hideLoading();
        }
      };

      // 기타 폼 렌더
      renderCommForms();
      renderOnehotsVisibility();
      renderOnehotForms();
    }

    // ===== one-hot =====
    function renderOnehotsVisibility(){
      const me = document.getElementById('fromId')?.value;
      ['reasonCommCard','reasonAcadCard','commCareer','reasonCareerCard'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(!me) el.classList.add('hidden'); else el.classList.remove('hidden');
      });
    }
    function buildOnehotForm(targetId, options){
      const wrap = document.getElementById(targetId);
      if(!wrap) return;
      wrap.innerHTML = '';
      const sel = document.createElement('select');
      sel.id = targetId + '_sel';
      sel.innerHTML = '<option value="">선택</option>' + options.map((t,i)=>`<option value="${i+1}">${i+1}. ${t}</option>`).join('');
      wrap.appendChild(sel);
      return sel;
    }
    function renderOnehotForms(){
      buildOnehotForm('reasonCommForm', REASON_COMM);
      buildOnehotForm('reasonAcadForm', REASON_ACAD);
      buildOnehotForm('reasonCareerForm', REASON_CAREER);

      const bind = (btnId, selId, kind, count)=>{
        const btn = document.getElementById(btnId);
        if (!btn) return;
        btn.onclick = async ()=>{
          const me = document.getElementById('fromId').value;
          if(!me){ alert('번호를 선택하세요.'); return; }
          const v = document.getElementById(selId).value;
          if(!v){ alert('항목을 선택하세요.'); return; }
          const payload = { action:'appendOnehot', class_code: CLASS_CODE, kind, row: { from: sid(me), choice: Number(v), count } };
          try{
            showLoading();
            const r = await apiPost(payload);
            await pingSubmit(kind);
            if(!r.ok) throw new Error(r.error || 'save failed');
            alert('제출되었습니다.'); showModal();
          }catch(e){
            alert('서버 오류가 발생했습니다. 다시 시도해 주세요.');
          } finally {
            hideLoading();
          }
        };
        const clrBtn = btnId.replace('save','clear');
        const clr = document.getElementById(clrBtn);
        if(clr){ clr.onclick=()=>{ const s=document.getElementById(selId); if(s) s.value=''; }; }
      };

      bind('saveReasonComm',   'reasonCommForm_sel',   'reason_comm',   REASON_COMM.length);
      bind('saveReasonAcad',   'reasonAcadForm_sel',   'reason_acad',   REASON_ACAD.length);
      bind('saveReasonCareer', 'reasonCareerForm_sel', 'reason_career', REASON_CAREER.length);
    }

    // ===== 매트릭스(의사소통/학업/진로) =====
    function renderCommForms(){
      const meEl = document.getElementById('fromId');
      if(!meEl) return;
      const me = meEl.value;

      const schoolWrap = document.getElementById('commSchoolForm');
      const acadWrap   = document.getElementById('commAcadForm');
      const careerWrap = document.getElementById('commCareerForm');
      const schoolCard = document.getElementById('commSchool');
      const acadCard   = document.getElementById('commAcad');
      const careerCard = document.getElementById('commCareer');
      if(!schoolWrap || !acadWrap || !schoolCard || !acadCard || !careerWrap || !careerCard) return;

      if(!me){
        [schoolWrap,acadWrap,careerWrap].forEach(w=>w.innerHTML='');
        [schoolCard,acadCard,careerCard].forEach(c=>c.classList.add('hidden'));
        return;
      }else{
        [schoolCard,acadCard,careerCard].forEach(c=>c.classList.remove('hidden'));
      }

      schoolWrap.innerHTML=''; acadWrap.innerHTML=''; careerWrap.innerHTML='';

      for(let i=1;i<=N;i++){
        const v = String(i).padStart(2,'0');
        if(v===me) continue;
        const name = (nameMap[v] || '');

        const mkLine = (wrap)=>{
          const line = document.createElement('div');
          line.style.display='grid';
          line.style.gridTemplateColumns='110px 1fr';
          line.style.gap='8px';
          line.style.margin='6px 0';

          const lbl = document.createElement('div');
          lbl.textContent = `${v} ${name}`; lbl.style.fontWeight='600';
          line.appendChild(lbl);

          const sel = document.createElement('select');
          sel.dataset.to = v;
          sel.innerHTML = '<option value="">선택</option>' + COMM_SCALE.map(o=>`<option value="${o.v}">${o.v}. ${o.t}</option>`).join('');
          line.appendChild(sel);
          wrap.appendChild(line);
        };

        mkLine(schoolWrap);
        mkLine(acadWrap);
        mkLine(careerWrap);
      }

      const saveMatrix = (btnId, formId, kind)=>{
        const btn = document.getElementById(btnId);
        if (!btn) return;
        btn.onclick=async ()=>{
          const me = document.getElementById('fromId').value;
          if(!me){ alert('번호를 선택하세요.'); return; }
          const selects = [...document.getElementById(formId).querySelectorAll('select')];
          const rows = selects.map(sel=>{
            const to = sel.dataset.to;
            const score = sel.value ? Number(sel.value) : 0;
            return { from:sid(me), to:sid(to), score };
          }).filter(r=> r.to !== sid(me));
          try{
            showLoading();
            const r = await apiPost({ action:'appendMatrix', class_code: CLASS_CODE, kind, rows });
            await pingSubmit(kind==='school'?'comm_school':(kind==='acad'?'comm_acad':'comm_career'));
            if(!r.ok) throw new Error('save failed');
            alert('제출되었습니다.'); showModal();
          }catch(e){
            alert('서버 오류가 발생했습니다. 다시 시도해 주세요.');
          } finally {
            hideLoading();
          }
        };
      };

      saveMatrix('saveCommSchool', 'commSchoolForm', 'school');
      saveMatrix('saveCommAcad',   'commAcadForm',   'acad');
      saveMatrix('saveCommCareer', 'commCareerForm', 'career');

      document.getElementById('clearCommSchool').onclick=()=>{ [...schoolWrap.querySelectorAll('select')].forEach(s=>s.value=''); };
      document.getElementById('clearCommAcad').onclick=()=>{   [...acadWrap.querySelectorAll('select')].forEach(s=>s.value='');   };
      document.getElementById('clearCommCareer').onclick=()=>{ [...careerWrap.querySelectorAll('select')].forEach(s=>s.value=''); };
    }

    // ===== CSV 다운로드 유틸 =====
    function nowTs(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${yyyy}${mm}${dd}_${hh}${mi}`;
    }

    async function downloadCsvBySheet(sheet, niceName){
  // 캐시 버스터 추가 (항상 최신 CSV)
  const url = `${API_BASE}?action=csv&sheet=${encodeURIComponent(sheet)}&class_code=${encodeURIComponent(CLASS_CODE)}&_=${Date.now()}`;

  // ✅ 예전 동작으로 복귀: 새 탭(또는 새 창)으로 직접 열어서 GAS가 다운로드를 처리하게 함
  const win = window.open(url, '_blank');

  // 팝업 차단된 경우 폴백: a 엘리먼트로 강제 오픈
  if (!win) {
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    // cross-origin이라 download 속성은 무시될 수 있지만, 열리면서 다운로드가 진행됨
    document.body.appendChild(a);
    a.click();
    setTimeout(()=> a.remove(), 0);
  }

  // 필요하면 자동 닫기(사이트가 뜨고 바로 사라지는 예전 UX 흉내)
  // setTimeout(()=> { try { win && win.close(); } catch(_){} }, 4000);
}


    // ===== 교사 화면 =====
    function initTeacher(){
      const login = document.getElementById('teacherLogin');
      const body = document.getElementById('teacherBody');

      document.getElementById('loginBtn').onclick=()=>{
        login.classList.add('hidden');
        body.classList.remove('hidden');

        // CSV 다운로드
        document.getElementById('downloadCsvBtn').onclick=()=> downloadCsvBySheet('edges',        '학생전체설문');
        document.getElementById('downloadSchoolMatrix').onclick=()=> downloadCsvBySheet('comm_school',  '의사소통빈도');
        document.getElementById('downloadAcadMatrix').onclick=()=>   downloadCsvBySheet('comm_acad',    '학업의사소통빈도');
        document.getElementById('downloadReasonComm').onclick=()=>   downloadCsvBySheet('reason_comm',  '의사소통계기');
        document.getElementById('downloadReasonAcad').onclick=()=>   downloadCsvBySheet('reason_acad',  '학업의사소통계기');
        document.getElementById('downloadCareerMatrix').onclick=()=> downloadCsvBySheet('comm_career',  '진로진학의사소통빈도');
        document.getElementById('downloadReasonCareer').onclick=()=> downloadCsvBySheet('reason_career','진로진학계기');

        // 초기화
        document.getElementById('clearAllBtn').onclick=async ()=>{
          if(!confirm('모든 응답을 초기화할까요? (공용 시트 전체 삭제)')) return;
          try{
            showLoading();
            const r = await apiPost({ action:'clearAll' });
            if(r.ok) alert('모든 응답이 초기화되었습니다.'); else alert('서버 오류');
          }catch(e){ alert('서버 오류'); }
          finally{ hideLoading(); }
        };

        // 미제출 현황
        const wrap = document.getElementById('missingWrap');
        async function refresh(){
          wrap.textContent = '불러오는 중...';
          try{
            const data = await apiGet({ action:'status', class_code: CLASS_CODE });
            if (!data || data.error) throw new Error(data && data.error || 'NO_DATA');

            const kinds = [
              ['edges','학생 설문(관계)'],
              ['comm_school','의사소통 빈도'],
              ['reason_comm','[1-A] 일반 의사소통 계기'],
              ['comm_acad','학업 의사소통 빈도'],
              ['reason_acad','[2-A] 학업 의사소통 계기'],
              ['comm_career','[3] 진학/진로 의사소통 빈도'],
              ['reason_career','[3-A] 진학/진로 계기']
            ];
            const allIds = Array.from({length:N},(_,i)=>pad2(i+1));
            const html = kinds.map(([key,label])=>{
              const arr = Array.isArray(data[key]) ? data[key] : [];
              const done = new Set(arr.map(s=>String(s).replace(/^S/,'').padStart(2,'0')));
              const missing = allIds.filter(id=>!done.has(id));
              const names = missing.map(v=>`${v} ${nameMap[v]||''}`).join(', ') || '없음';
              const doneNames = allIds.filter(id=>done.has(id)).map(v=>`${v} ${nameMap[v]||''}`).join(', ') || '없음';
              return `<div><b>${label}</b><br/>제출: ${doneNames}<br/>미제출: ${names}</div>`;
            }).join('<hr/>');
            wrap.innerHTML = html;
          }catch(e){
            wrap.textContent = '불러오기에 실패했습니다. (상세: ' + (e.message||'unknown') + ')';
          }
        }
        document.getElementById('refreshMissing').onclick=refresh;
        refresh();
      };
    }

    // 자동 렌더
    window.addEventListener('load',()=>{
      const goBtn = document.getElementById('goStudent');
      if(goBtn){
        goBtn.addEventListener('click',()=> setTimeout(()=>{
          const meSel = document.getElementById('fromId');
          if(meSel){
            meSel.addEventListener('change', ()=>{ renderCommForms(); renderOnehotsVisibility(); });
            renderCommForms();
            renderOnehotsVisibility();
            renderOnehotForms();
          }
        }, 200));
      }
    });
  </script>
</body>
</html>
